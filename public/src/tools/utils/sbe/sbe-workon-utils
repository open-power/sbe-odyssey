#!/bin/sh
# IBM_PROLOG_BEGIN_TAG
# This is an automatically generated prolog.
#
# $Source: public/src/tools/utils/sbe/sbe-workon-utils $
#
# OpenPOWER sbe Project
#
# Contributors Listed Below - COPYRIGHT 2023
# [+] International Business Machines Corp.
#
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing
# permissions and limitations under the License.
#
# IBM_PROLOG_END_TAG

# sourcing detect-python file
source public/src/tools/utils/sbe/detect-python

# Common function for swaping new shell
swapingNewShell()
{
    PYTHON_VERSION=$(get_python_version)
    echo "Python Version: $PYTHON_VERSION"

    # For machines which have python2 as default(mostly all CI machines)
    # execute scl command. Do nothing if python3 is default.
    if [[ "$PYTHON_VERSION" == "3" ]]; then
        echo "***INFO | Machine has Python3 as default"
        echo "Spawning new shell (/bin/bash)..."
        export SCL_PYTHON_ENABLED=0
        bash --rcfile ./env.bash -i || exit -1
    elif [[ "$PYTHON_VERSION" == "2" ]]; then
        echo "***INFO | Machine has Python2 as default"
        # we need to pass "bash --rcfile ./env.bash" as single argument to scl command
        CMD_ARR=("scl" "enable" "rh-python36" "bash --rcfile ./env.bash -i")
        export SCL_PYTHON_ENABLED=1
        echo "Spawning new shell : ${CMD_ARR[@]}"
        "${CMD_ARR[@]}" || exit -1
    else
        echo "Error: sbe-workon-utils | swapingNewShell          | Cannot detect python2 or python3"
        exit -1
    fi
}

# Function for install required packages which is their in requirements.txt
installRequiredPackages()
{
    echo "Installing Required packages..."

    # Check the SCL is enable, if SCL is enable python3 default path /opt/rh/rh-python36/root/usr/bin/python3
    if [ "$SCL_PYTHON_ENABLED" == 1 ]; then
        # default python 2 scl, Intstalling packages in $HOME/.local_rh_python36/ path
        # --no-warn-script-location supress the warning message for changing pythonuserbase location
        CMD="pip install --no-warn-script-location"
     elif [ "$SCL_PYTHON_ENABLED" == 0 ]; then
        # default python 3 path /user/bin/python3 or /bin/python3, Installing packages in $HOME/.local/
        CMD="python3 -m pip install"
    else
        echo "Error: sbe-workon-utils | installRequiredPackages | SCL_PYTHON_ENABLED is not defined"
        exit -1
    fi

    CMD="$CMD -r $SBEROOT_PUB/src/tools/install/buildtoolrequirements.txt      \
              -r $SBEROOT_PUB/src/tools/install/debugtoolrequirements.txt      \
              -r $SBEROOT_PUB/src/tools/install/regressiontoolrequirements.txt \
            --user"
    echo $CMD
    $CMD || {
        if (($? != 0)); then
            echo "Error: sbe-workon-utils | installRequiredPackages  | Failure: $?. Please do workon again."
        fi
        exit -1
    }
}
